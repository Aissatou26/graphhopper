name: Build and Test
on:
  push: {}
  pull_request: {}
  workflow_dispatch: {}
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Use supported Java versions on GitHub runners. Java 17 (LTS) and 21 are commonly available
        # and compatible with our PIT and JaCoCo toolchain. 24/25-ea may not be present and cause CI failure.
        java-version: [ 17, 21 ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os}}-node-
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os}}-node_modules-
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test

 # Mutation testing job
  mutation:
    name: Mutation coverage check
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Prepare core dependencies
        # Build required modules and install snapshots so PIT can resolve dependencies
        run: mvn -B -DskipTests -DskipITs -pl core -am install

      - name: Run PIT mutation testing for core
        # Run PIT only against the core module pom now that dependencies are installed
        # Pass an empty argLine to avoid PIT launching a minion with a literal ${argLine}
        # (which leads to ClassNotFoundException: ${argLine}). See CI logs for MINION_DIED.
        run: mvn -f core/pom.xml -Ppitest org.pitest:pitest-maven:mutationCoverage -Dpitest.outputFormats=XML,HTML -Dpitest.timestampedReports=false -DargLine=""
      - name: Upload PIT reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pit-reports-core
          path: core/target/pit-reports/**

      - name: Upload JaCoCo site and exec (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-core
          path: |
            core/target/site/jacoco/**
            core/target/jacoco.exec

      - name: Compare mutation score against baseline
        run: bash ci/check-mutation-score.sh core

